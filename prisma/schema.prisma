generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("PRISMA_DATABASE_URL")
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  emailVerified     Boolean            @default(false) @map("email_verified")
  name              String
  image             String?
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  points            Int                @default(0)
  level             Int                @default(1)
  role              UserRole           @default(USER)
  isActive          Boolean            @default(true) @map("is_active")
  lastLoginAt       DateTime?          @map("last_login_at")
  // 2FA fields
  twoFactorEnabled  Boolean            @default(false) @map("two_factor_enabled")
  accounts          Account[]
  notifications     Notification[]
  pushSubscriptions PushSubscription[]
  reports           Report[]
  sessions          Session[]
  achievements      UserAchievement[]
  userRewards       UserReward[]
  wasteDisposals    WasteDisposal[]
  // Manager assignments
  assignedWasteDisposals WasteDisposal[] @relation("WasteManager")
  // Point transactions
  pointTransactions PointTransaction[]
  // 2FA relation
  twoFactor         TwoFactor?

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  token     String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id                    String    @id @default(cuid())
  userId                String    @map("user_id")
  accountId             String    @map("account_id")
  providerId            String    @map("provider_id")
  accessToken           String?   @map("access_token")
  refreshToken          String?   @map("refresh_token")
  idToken               String?   @map("id_token")
  accessTokenExpiresAt  DateTime? @map("access_token_expires_at")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@map("accounts")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@unique([identifier, value])
  @@map("verifications")
}

model WasteBin {
  id             String          @id @default(cuid())
  name           String
  type           WasteType
  latitude       Decimal         @db.Decimal(10, 8)
  longitude      Decimal         @db.Decimal(11, 8)
  qrCode         String          @unique @map("qr_code")
  status         WasteBinStatus  @default(ACTIVE)
  capacity       Int             @default(100)
  lastEmptied    DateTime?       @map("last_emptied")
  address        String?
  description    String?
  imageUrl       String?         @map("image_url")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  reports        Report[]

  @@map("waste_bins")
}

model WasteDisposal {
  id                 String           @id @default(cuid())
  userId             String           @map("user_id")
  wasteCategoryId    String           @map("waste_category_id")
  quantity           Decimal          @db.Decimal(8, 2)
  description        String?
  imageUrl           String?          @map("image_url")
  latitude           Decimal          @db.Decimal(10, 8)
  longitude          Decimal          @db.Decimal(11, 8)
  address            String?
  status             WasteDisposalStatus @default(PENDING)
  assignedManagerId  String?          @map("assigned_manager_id")
  adminNotes         String?          @map("admin_notes")
  notes              String?
  approvedAt         DateTime?        @map("approved_at")
  rejectedAt         DateTime?        @map("rejected_at")
  completedAt        DateTime?        @map("completed_at")
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")
  
  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  wasteCategory      WasteCategory    @relation(fields: [wasteCategoryId], references: [id])
  assignedManager    User?            @relation("WasteManager", fields: [assignedManagerId], references: [id])

  @@map("waste_disposals")
}

model WasteCategory {
  id             String          @id @default(cuid())
  name           String
  description    String?
  pointsPerUnit  Int             @map("points_per_unit")
  color          String?
  isActive       Boolean         @default(true) @map("is_active")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  
  wasteDisposals WasteDisposal[]

  @@map("waste_categories")
}

model PointTransaction {
  id            String              @id @default(cuid())
  userId        String              @map("user_id")
  type          PointTransactionType
  amount        Int
  description   String
  referenceId   String?             @map("reference_id")
  referenceType String?             @map("reference_type")
  createdAt     DateTime            @default(now()) @map("created_at")
  
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("point_transactions")
}

model RewardCategory {
  id             String         @id @default(cuid())
  name           String
  description    String?
  color          String?
  isActive       Boolean         @default(true) @map("is_active")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  
  rewards        Reward[]

  @@map("reward_categories")
}

model Reward {
  id             String         @id @default(cuid())
  name           String
  description    String?
  pointsRequired Int            @map("points_required")
  imageUrl       String?        @map("image_url")
  categoryId     String         @map("category_id")
  stock          Int?
  isActive       Boolean        @default(true) @map("is_active")
  expiresAt      DateTime?      @map("expires_at")
  terms          String?
  partnerName    String?        @map("partner_name")
  partnerLogo    String?        @map("partner_logo")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  
  category       RewardCategory @relation(fields: [categoryId], references: [id])
  userRewards    UserReward[]

  @@map("rewards")
}

model UserReward {
  id          String           @id @default(cuid())
  userId      String           @map("user_id")
  rewardId    String           @map("reward_id")
  status      UserRewardStatus @default(PENDING)
  pointsSpent Int              @map("points_spent")
  adminNotes  String?          @map("admin_notes")
  approvedAt  DateTime?        @map("approved_at")
  completedAt DateTime?        @map("completed_at")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  
  reward      Reward           @relation(fields: [rewardId], references: [id], onDelete: Cascade)
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_rewards")
}

model Achievement {
  id               String            @id @default(cuid())
  name             String
  description      String
  icon             String?
  type             String
  requirement      Int
  bonusPoints      Int               @default(0) @map("bonus_points")
  isActive         Boolean           @default(true) @map("is_active")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  
  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String      @map("user_id")
  achievementId String      @map("achievement_id")
  unlockedAt    DateTime    @default(now()) @map("unlocked_at")
  progress      Json?
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model Report {
  id          String         @id @default(cuid())
  userId      String         @map("user_id")
  wasteBinId  String?        @map("waste_bin_id")
  type        ReportType
  description String
  imageUrl    String?        @map("image_url")
  location    Json?
  status      ReportStatus   @default(PENDING)
  priority    ReportPriority @default(MEDIUM)
  resolvedAt  DateTime?      @map("resolved_at")
  resolvedBy  String?        @map("resolved_by")
  createdAt   DateTime       @default(now()) @map("created_at")
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  wasteBin    WasteBin?      @relation(fields: [wasteBinId], references: [id])

  @@map("reports")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String           @map("user_id")
  title     String
  body      String
  type      NotificationType
  data      Json?
  read      Boolean          @default(false)
  sentAt    DateTime?        @map("sent_at")
  createdAt DateTime         @default(now()) @map("created_at")
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  endpoint  String
  p256dh    String
  auth      String
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("push_subscriptions")
}

model Campaign {
  id          String     @id @default(cuid())
  name        String
  description String
  startDate   DateTime   @map("start_date")
  endDate     DateTime   @map("end_date")
  multiplier  Decimal    @default(1.0) @db.Decimal(3, 2)
  targetType  WasteType? @map("target_type")
  active      Boolean    @default(true)
  imageUrl    String?    @map("image_url")
  rules       Json?
  createdAt   DateTime   @default(now()) @map("created_at")

  @@map("campaigns")
}

model TwoFactor {
  id          String   @id @default(cuid())
  userId      String   @unique @map("user_id")
  secret      String? // For TOTP
  backupCodes String?  @map("backup_codes") // JSON string of backup codes
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("two_factor")
}

enum UserRole {
  USER
  WASTE_MANAGER
  ADMIN
  SUPER_ADMIN
}

enum WasteType {
  RECYCLING
  COMPOST
  GENERAL
  ELECTRONIC
  HAZARDOUS
  TEXTILE
  GLASS
  METAL
  PAPER
  PLASTIC
}

enum WasteBinStatus {
  ACTIVE
  FULL
  MAINTENANCE
  INACTIVE
}



enum UserRewardStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum AchievementRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

enum ReportType {
  BIN_FULL
  BIN_DAMAGED
  ILLEGAL_DUMPING
  CONTAMINATION
  MISSING_BIN
  OTHER
}

enum ReportStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  REJECTED
}

enum ReportPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum NotificationType {
  POINTS_EARNED
  LEVEL_UP
  REWARD_AVAILABLE
  ACHIEVEMENT_UNLOCKED
  CAMPAIGN_STARTED
  BIN_NEARBY
  REMINDER
  SYSTEM
}

enum WasteDisposalStatus {
  PENDING
  APPROVED
  REJECTED
  IN_PROGRESS
  COMPLETED
}

enum PointTransactionType {
  EARNED
  SPENT
  BONUS
  PENALTY
}
